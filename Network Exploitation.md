# Nmap
Nmap is a port-scanning tool which basically connects to each port of the target in turn. Depending on the response it gets it determines the port as open, closed or filltered (by a firewall). After we know which ports are open,, we can then find out what services are running on them and start enumerating them.
## Scan Types
Nmap offers three basic scan types:
- TCP Connect Scans (`-sT`)
- SYN "Half-open" Scans (`-sS`)
- UDP Scans (`-SU`)

Additionaly there are less common scan types, three of them are:
- TCP Null Scans (`-sN`)
- TCP FIN Scans (`-sF`)
- TCP Xmas Scan (`-sX`)

Besides the UDP scan these have a similar purpose but work differently.

>[!info]
> To understand the TCP Connect and the SYN Scan you should know about the [[Network Fundamentals#TCP Three-Way-Handshake|Three-Way-Handshake]]  
### TCP Connect Scan
The TCP Connect Scan (`-sT`) is done by performing the TCP Three-Way-Handshake with each port in turn. In other words Nmap tries to connect to each specific TCP port.
If a port is closed it will respond with a packet with the RST (Reset) flag set and Nmap can establish that.   
Many firewalls are configured to simply drop incoming packets, meaning that if Nmap sends a TCP SYN request and receives nothing back, Nmap consideres the port as *filtered*. Although it is also easy to configure a firewall that it responds with a RST packet. 

### SYN Scan
The TCP SYN scan (`-sS`) , also known as *"Half-open* or *"Stealth* scan, does not complete the Three-Way-Handshake, instead sending a RST TCP packet after receiving a SYN/ACK packet form the target. The SYN scan is the default scan when Nmap is run with `sudo`, else the default is the TCP connect scan.

Advantages:
- can bypass older Intrusion Detection systems
- often not logged by applications listening on open ports
- faster than standart TCP Connect scan

Disadvantages:
- require "sudo" permissions 
- unstable services are sometimes brought dowm by this scan

### UDP Scan
[[Network Fundamentals#UDP/IP|UDP]] is more difficult and slower to scan, because it is *stateless*, meaning there is no "handshake" to establish a connection. 
When a packet is send to a port during a UDP scan (`-sU`) there should be no response, a requeset is than send again to double check and the port is marked as open | filtered. If there is a response the port is marked as open. A closed UDP port responds with a ICMP packet messaging that the port is unreachable.

### NULL, FIN and XMAS Scan
These scans are less commonly used than the other scans but are used with firewall evasion as many firewalls are configured to drop incoming TCP packets with the SYN flag set. 
[RFC 793](https://datatracker.ietf.org/doc/html/rfc793) mandates that hosts respond to malformed packets with a RST TCP packet when the port is closed and no response if the port is open, but is not always practiced.
Modern IDS are aware of these scans so do not rely on them to be 100% effective.
These scans will mark ports only as open | filtered (no response), closed (RST response) or filtered (ICMP unreachable packet).
- **NULL scan (`-sN`):** sends a TCP request with no flags set
- **FIN scan (`-sF`):** sends a packet with the FIN flag set (used to close a connection) 
- **XMAS scan (`-sX`)** sends a malformed packet with the PSH, URG adn FIN flag set

### ICMP Network Scanning
To find out what IP addresses on a network contain active hosts we can perform a "ping sweep", sending a ICMP packet to every possible address and marking the address as open when there is a response.
A "ping sweep" is performed with the `-sN` switch and the IP address range either with hypen (`-`) or in CIDR notation. 
```
nmap -sN 192.168.0.1-254
nmap -sN 192.168.0.0/24
```
The `-sN` switch also tells Nmap to send a TCP SYN packet to port 443 and a TCP ACK (or SYN when not as root) to port 80 of the target.

## NES Scripts
### Overview
The *Nmap Scripting Engine (NES)* executes scripts written in the [Lua](https://www.lua.org/pil/contents.html) programming language, allowing you to extend the functionality of Nmap scans.
Some categories in the script library are:
- **safe:** Will not affect the target
- **intrusive**: likely to affect the target
- **vuln**: Scan for vulnerabilities
- **exploit**: Attempt to exploit a vulnerability
- **auth**: Attempt to bypass authentication for running services 
- **brute**: Attempt to bruteforce credentials for running services
- **discovery**: Attempt to query running services for information about the network (query a SNMP server)

A longer list can be found [here](https://nmap.org/book/nse-usage.html).

## Working with the NSE
To run any applicable script from a category against a target you use `--script=category`, for example `--script=safe`.
To run a specific script use `--script=scriptName`, for example `--script=http-fielupload-exploiter`